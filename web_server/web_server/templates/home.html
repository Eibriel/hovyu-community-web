{% extends "layout.html" %}
{% from '_add_edit_modal.html' import add_edit_modal, add_edit_modal_js %}
{% from '_upgrade_modal.html' import upgrade_modal, upgrade_modal_js %}
{% from '_list_stores.html' import list_stores, list_stores_js %}
{% block body %}
    <div class="row">
        <h1 style="text-align: center;">Comunidad WIDÚ</h1>
    </div>
    <div style="text-align: center; margin-top: 10px; margin-bottom: 20px;">
        <button type="button" class="btn btn-primary btn-sm" data-toggle="modal" data-target="#addEditModal">
          Sumar comercio
        </button>
    </div>
    <div class="row">
        <div class="col-lg-3">
        </div> 
        <div class="col-lg-6">
            <form action="/" method="GET">
                <input type="hidden" name="latitude" id="q_latitude" value="{{latitude}}">
                <input type="hidden" name="longitude" id="q_longitude" value="{{longitude}}">
                <input type="hidden" name="location_name" id="q_location_name" value="{{location_name}}">
                <input type="hidden" name="product" id="q_product" value="{{product}}">
                <input type="hidden" name="product_name" id="q_product_name" value="{{product_name}}">
                <button type="submit" class="btn btn-default btn-lg" style="margin-bottom: 1em;">
                    <div>Busco <span class="label label-primary" id="query_product">{{product_name}}</span> cerca de <span class="label label-success" id="query_place">{{location_name}}</span></div>
                </button>
            </form>
            <div class="form-group">
              <input type="text" class="form-control" placeholder="Busco..." name="q" id="q" autocomplete="off">
              <!--<span class="input-group-btn">
                <button class="btn btn-success" type="button">DÚ!</button>
              </span>-->
            </div><!-- /input-group -->
            <div class="panel panel-default">
                <div class="panel-body">
                    <div id="query_items"></div>
                </div>
            </div>
        </div> 
        <div class="col-lg-3">
        </div> 
    </div><!-- /row -->
                        
    {{ list_stores(items) }}

</div>

{{ msg }}

{{ add_edit_modal(edit_item, products) }}
{{ upgrade_modal() }}

{% endblock %}

{% block scripts %}
{{ list_stores_js(items) }}
{{ add_edit_modal_js() }}
{{ upgrade_modal_js() }}
<script>
$("#q").keyup(function() {
    if ($('#q').val()=="") {
        return;
    }
    $.ajax({
      method: "POST",
      url: "/build_query",
      type: "json",
      data: { q: $('#q').val() }
    })
      .done(function( msg ) {
        var html = "<p>";
        var name = "";
        var _id = "";
        for (var index in msg['products']) {
            name = msg['products'][index]['name'];
            _id = msg['products'][index]['_id'];
            html += "<a class='btn btn-primary' role='button' href='#' onclick='return add_query_product(\""+_id+"\", \""+name+"\")'>"+name+"</a> ";
        }
        html += "</p><p>";
        for (var index in msg['places']) {
        name = msg['places'][index]
            html += "<a class='btn btn-success' role='button' href='#' onclick='return add_query_place(\""+name+"\")'>"+name+"</a> ";
        }
        html += "</p>";
        $("#query_items").html(html);
      });
});

function add_query_product(_id, name) {
    $("#query_product").html(name);
    $('#q_product').val(_id);
    $('#q_product_name').val(name);
    $("#query_items").html("");
    $('#q').val("");
    return false;
}

function add_query_place(name) {
    $("#query_place").html(name);
    if (name=='cualquier lado') {
        $('#q_latitude').val("");
        $('#q_longitude').val("");
    } else {
        $('#q_latitude').val(latitude);
        $('#q_longitude').val(longitude);
    }
    $('#q_location_name').val(name);
    $("#query_items").html("");
    $('#q').val("");
    return false;
}
</script>

{% if editing %}
<script>
$('#addEditModal').modal('show')
</script>
{% endif %}

{% endblock %}
